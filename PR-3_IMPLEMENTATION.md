# PR-3: cfomicsPython Skeleton

## ÁõÆÁöÑ

`packages/cfomicsPython/` „Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÈ™®ÁµÑ„Åø„Çí‰ΩúÊàê„Åó„ÄÅÂçòÁã¨„Åß `R CMD check` „ÅåÈÄö„ÇãÁä∂ÊÖã„Å´„Åô„Çã„ÄÇÂÆüÈöõ„ÅÆ Python „Ç≥„Éº„ÉâÁßªÊ§ç„ÅØ PR-4 „ÅßË°å„ÅÜ„ÄÇ

## ÂâçÊèêÊù°‰ª∂

- [ ] PR-1 „Åå„Éû„Éº„Ç∏Ê∏à„ÅøÔºàpackages/ ÊßãÈÄ†Ôºâ
- [ ] PR-2 „Åå„Éû„Éº„Ç∏Ê∏à„ÅøÔºàregistry „Ç∑„Çπ„ÉÜ„É†Ôºâ

## „Éñ„É©„É≥„ÉÅ

```bash
git checkout main
git pull origin main
git checkout -b feature/cfomics-python-skeleton
```

---

## ‰ΩúÊ•≠ÊâãÈ†Ü

### Step 1: „Éá„Ç£„É¨„ÇØ„Éà„É™ÊßãÈÄ†„ÅÆ‰ΩúÊàê

```bash
mkdir -p packages/cfomicsPython/R
mkdir -p packages/cfomicsPython/inst/python
mkdir -p packages/cfomicsPython/tests/testthat
mkdir -p packages/cfomicsPython/man
```

### Step 2: DESCRIPTION „ÅÆ‰ΩúÊàê

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/DESCRIPTION`

```
Package: cfomicsPython
Title: Python Backends for cfomics
Version: 0.1.0
Authors@R:
    person("Yusuke", "Matsui", , "matsui@example.com", role = c("aut", "cre"),
           comment = c(ORCID = "0000-0000-0000-0000"))
Description: Provides Python-based causal inference methods for the cfomics
    ecosystem. Includes backends for DoWhy, EconML, GANITE, and CAVAE.
    Requires Python and relevant Python packages to be installed.
License: MIT + file LICENSE
Encoding: UTF-8
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.3.1
Depends:
    R (>= 4.2.0)
Imports:
    cfomics,
    reticulate,
    rlang,
    cli
Suggests:
    testthat (>= 3.0.0)
Config/testthat/edition: 3
```

### Step 3: NAMESPACE „ÅÆ‰ΩúÊàê

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/NAMESPACE`

```
# Generated by roxygen2: do not edit by hand

export(cf_check_env)
export(cf_install_python_env)
export(cf_use_python_env)
export(cf_list_python_envs)
import(cfomics)
importFrom(reticulate,py_available)
importFrom(reticulate,py_module_available)
importFrom(reticulate,use_condaenv)
importFrom(rlang,abort)
importFrom(cli,cli_alert_success)
importFrom(cli,cli_alert_warning)
```

### Step 4: LICENSE „ÅÆ‰ΩúÊàê

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/LICENSE`

```
YEAR: 2024
COPYRIGHT HOLDER: Yusuke Matsui
```

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/LICENSE.md`

```markdown
# MIT License

Copyright (c) 2024 Yusuke Matsui

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

### Step 5: „Éë„ÉÉ„Ç±„Éº„Ç∏„Éâ„Ç≠„É•„É°„É≥„Éà„ÅÆ‰ΩúÊàê

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/R/cfomicsPython-package.R`

```r
#' @keywords internal
"_PACKAGE"

#' @import cfomics
#' @importFrom reticulate py_available py_module_available use_condaenv
#' @importFrom rlang abort
#' @importFrom cli cli_alert_success cli_alert_warning
NULL

.onLoad <- function(libname, pkgname) {
 # Register Python methods with cfomics
  # NOTE: This only registers methods, does NOT initialize Python
  .register_python_methods()

  invisible()
}

#' Register Python-based methods with cfomics registry
#' @keywords internal
#' @noRd
.register_python_methods <- function() {
  # DoWhy GCM
  cfomics::cf_register_method(
    id = "dowhy_gcm",
    fit_fun = cf_fit_dowhy_gcm,
    predict_fun = NULL,
    requires_python = TRUE,
    package = "cfomicsPython",
    description = "DoWhy GCM (Graphical Causal Model)"
  )

  # DRLearner (EconML)
  cfomics::cf_register_method(
    id = "drlearner",
    fit_fun = cf_fit_drlearner,
    predict_fun = predict_cf_drlearner,
    requires_python = TRUE,
    package = "cfomicsPython",
    description = "Double Robust Learner (EconML)"
  )

  # GANITE
  cfomics::cf_register_method(
    id = "ganite",
    fit_fun = cf_fit_ganite,
    predict_fun = predict_cf_ganite,
    requires_python = TRUE,
    package = "cfomicsPython",
    description = "GANITE (Generative Adversarial Nets for ITE)"
  )

  # CAVAE
  cfomics::cf_register_method(
    id = "cavae",
    fit_fun = cf_fit_cavae,
    predict_fun = predict_cf_cavae,
    requires_python = TRUE,
    package = "cfomicsPython",
    description = "Causal Autoencoder VAE"
  )

  invisible()
}
```

### Step 6: Python Áí∞Â¢ÉÁÆ°ÁêÜ„ÅÆ„Çπ„Çø„Éñ

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/R/python_env.R`

```r
#' Install Python environment for cfomics
#'
#' @param env_name Character. Name of the conda environment
#' @param method Character. Installation method: "conda" or "virtualenv"
#' @param python_version Character. Python version to use
#'
#' @return Invisible TRUE on success
#' @export
#'
#' @examples
#' \dontrun{
#' cf_install_python_env()
#' cf_install_python_env("my_env", method = "conda")
#' }
cf_install_python_env <- function(env_name = "cfomics",
                                   method = c("conda", "virtualenv"),
                                   python_version = "3.10") {
  method <- match.arg(method)

  # TODO: Implement in PR-4
  rlang::abort(
    "cf_install_python_env() is not yet implemented. Coming in a future release.",
    class = "cfomics_not_implemented"
  )
}

#' Use a Python environment
#'
#' @param env_name Character. Name of the conda environment
#' @param required Logical. Error if environment not found?
#'
#' @return Invisible TRUE on success
#' @export
#'
#' @examples
#' \dontrun{
#' cf_use_python_env("cfomics")
#' }
cf_use_python_env <- function(env_name = "cfomics", required = TRUE) {
  # TODO: Implement in PR-4
  rlang::abort(
    "cf_use_python_env() is not yet implemented. Coming in a future release.",
    class = "cfomics_not_implemented"
  )
}

#' List available Python environments
#'
#' @return A data.frame with environment information
#' @export
#'
#' @examples
#' \dontrun{
#' cf_list_python_envs()
#' }
cf_list_python_envs <- function() {
  # TODO: Implement in PR-4
  rlang::abort(
    "cf_list_python_envs() is not yet implemented. Coming in a future release.",
    class = "cfomics_not_implemented"
  )
}

#' Check Python environment status
#'
#' @return A cf_env_check object with diagnostic information
#' @export
#'
#' @examples
#' \dontrun{
#' cf_check_env()
#' }
cf_check_env <- function() {
  # Basic implementation that doesn't require Python initialization

  python_available <- tryCatch({
    reticulate::py_available(initialize = FALSE)
  }, error = function(e) FALSE)

  result <- list(
    python_available = python_available,
    python_path = if (python_available) {
      tryCatch(reticulate::py_config()$python, error = function(e) NA_character_)
    } else {
      NA_character_
    },
    modules = list(
      dowhy = NA,
      econml = NA,
      tensorflow = NA,
      torch = NA
    ),
    checked_at = Sys.time()
  )

  structure(result, class = "cf_env_check")
}

#' @export
print.cf_env_check <- function(x, ...) {
  cli::cli_h1("cfomicsPython Environment Check")

  if (x$python_available) {
    cli::cli_alert_success("Python: Available")
    if (!is.na(x$python_path)) {
      cli::cli_text("  Path: {.path {x$python_path}}")
    }
  } else {
    cli::cli_alert_warning("Python: Not available")
    cli::cli_text("  Run {.code cf_install_python_env()} to set up Python")
  }

  invisible(x)
}
```

### Step 7: Method „Çπ„Çø„Éñ„ÅÆ‰ΩúÊàê

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/R/methods_stub.R`

```r
#' Fit DoWhy GCM model
#' @inheritParams cfomics::cf_fit
#' @keywords internal
#' @noRd
cf_fit_dowhy_gcm <- function(formula, data, ...) {
  .require_python_impl("cf_fit_dowhy_gcm")
}

#' Fit DRLearner model
#' @inheritParams cfomics::cf_fit
#' @keywords internal
#' @noRd
cf_fit_drlearner <- function(formula, data, ...) {
  .require_python_impl("cf_fit_drlearner")
}

#' Predict with DRLearner model
#' @keywords internal
#' @noRd
predict_cf_drlearner <- function(object, newdata, ...) {
  .require_python_impl("predict_cf_drlearner")
}

#' Fit GANITE model
#' @inheritParams cfomics::cf_fit
#' @keywords internal
#' @noRd
cf_fit_ganite <- function(formula, data, ...) {
  .require_python_impl("cf_fit_ganite")
}

#' Predict with GANITE model
#' @keywords internal
#' @noRd
predict_cf_ganite <- function(object, newdata, ...) {
  .require_python_impl("predict_cf_ganite")
}

#' Fit CAVAE model
#' @inheritParams cfomics::cf_fit
#' @keywords internal
#' @noRd
cf_fit_cavae <- function(formula, data, ...) {
  .require_python_impl("cf_fit_cavae")
}

#' Predict with CAVAE model
#' @keywords internal
#' @noRd
predict_cf_cavae <- function(object, newdata, ...) {
  .require_python_impl("predict_cf_cavae")
}

#' Helper to indicate Python implementation needed
#' @keywords internal
#' @noRd
.require_python_impl <- function(func_name) {
  rlang::abort(
    paste0(
      func_name, "() requires Python implementation.\n",
      "This is a stub function. Full implementation coming in PR-4."
    ),
    class = "cfomics_not_implemented"
  )
}
```

### Step 8: „ÉÜ„Çπ„Éà„ÅÆ‰ΩúÊàê

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/tests/testthat.R`

```r
library(testthat)
library(cfomicsPython)

test_check("cfomicsPython")
```

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/tests/testthat/test-stub.R`

```r
test_that("cfomicsPython loads without error", {
  expect_true("cfomicsPython" %in% loadedNamespaces())
})

test_that("Python methods are registered", {
  # cfomics must be loaded first
  library(cfomics)

  methods <- cf_methods(include_unavailable = TRUE)

  # Python methods should be registered (but may not be available)
  expect_true("dowhy_gcm" %in% methods$id)
  expect_true("drlearner" %in% methods$id)
  expect_true("ganite" %in% methods$id)
  expect_true("cavae" %in% methods$id)
})

test_that("Python methods are marked as requiring Python", {
  library(cfomics)

  methods <- cf_methods(include_unavailable = TRUE)
  python_methods <- methods[methods$package == "cfomicsPython", ]

  expect_true(all(python_methods$requires_python))
})

test_that("cf_check_env returns cf_env_check object", {
  result <- cf_check_env()

  expect_s3_class(result, "cf_env_check")
  expect_true("python_available" %in% names(result))
})

test_that("stub functions error appropriately", {
  expect_error(
    cf_install_python_env(),
    class = "cfomics_not_implemented"
  )

  expect_error(
    cf_use_python_env(),
    class = "cfomics_not_implemented"
  )
})
```

### Step 9: NEWS.md „ÅÆ‰ΩúÊàê

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/NEWS.md`

```markdown
# cfomicsPython 0.1.0

## Initial Release

* Package skeleton created
* Python environment management stubs (`cf_install_python_env`, `cf_use_python_env`)
* Method registration for Python backends (dowhy_gcm, drlearner, ganite, cavae)
* `cf_check_env()` for environment diagnostics

## Note

This is a skeleton release. Full Python method implementations will be added in future versions.
```

### Step 10: .Rbuildignore „ÅÆ‰ΩúÊàê

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/.Rbuildignore`

```
^.*\.Rproj$
^\.Rproj\.user$
^LICENSE\.md$
```

### Step 11: README „ÅÆ‰ΩúÊàê

**„Éï„Ç°„Ç§„É´**: `packages/cfomicsPython/README.md`

```markdown
# cfomicsPython

Python backends for the cfomics ecosystem.

## Installation

```r
# Install cfomics first
remotes::install_github("matsui-lab/cfomics", subdir = "packages/cfomics")

# Then install cfomicsPython
remotes::install_github("matsui-lab/cfomics", subdir = "packages/cfomicsPython")
```

## Setup

```r
library(cfomicsPython)

# Check environment status
cf_check_env()

# Install Python environment (if needed)
cf_install_python_env()

# Use the environment
cf_use_python_env()
```

## Available Methods

| Method | Backend | Description |
|--------|---------|-------------|
| `dowhy_gcm` | DoWhy | Graphical Causal Model |
| `drlearner` | EconML | Double Robust Learner |
| `ganite` | TensorFlow | Generative Adversarial Nets for ITE |
| `cavae` | PyTorch/Pyro | Causal Autoencoder VAE |

## Usage

```r
library(cfomics)
library(cfomicsPython)

# Setup Python (first time only)
cf_install_python_env()
cf_use_python_env()

# Fit model
result <- cf_fit(Y ~ T | X1 + X2, data = df, method = "drlearner")
```

## License

MIT
```

---

## Ê§úË®ºÊâãÈ†Ü

### Step A: „Éâ„Ç≠„É•„É°„É≥„ÉàÁîüÊàê

```bash
cd packages/cfomicsPython
Rscript -e "devtools::document()"
```

### Step B: „Éë„ÉÉ„Ç±„Éº„Ç∏„Éì„É´„Éâ

```bash
cd packages/cfomicsPython
R CMD build .
```

### Step C: „Éë„ÉÉ„Ç±„Éº„Ç∏„ÉÅ„Çß„ÉÉ„ÇØ

```bash
R CMD check cfomicsPython_*.tar.gz --as-cran
```

### Step D: „ÉÜ„Çπ„ÉàÂÆüË°å

```r
devtools::test("packages/cfomicsPython")
```

### Step E: „Ç§„É≥„Çπ„Éà„Éº„É´„ÉÜ„Çπ„Éà

```r
# cfomics „ÅåÂøÖË¶Å
devtools::install("packages/cfomics")
devtools::install("packages/cfomicsPython")

library(cfomics)
library(cfomicsPython)

# Methods „ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
cf_methods(include_unavailable = TRUE)
```

---

## DoD „ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà

- [ ] `packages/cfomicsPython/` „Éá„Ç£„É¨„ÇØ„Éà„É™„ÅåÂ≠òÂú®
- [ ] DESCRIPTION „ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã
- [ ] cfomics „Å∏„ÅÆ‰æùÂ≠ò„ÅåÂÆ£Ë®Ä„Åï„Çå„Å¶„ÅÑ„Çã
- [ ] `R CMD build` „ÅåÊàêÂäü„Åô„Çã
- [ ] `R CMD check` „Åå ERROR „Å™„Åó„ÅßÈÄö„Çã
- [ ] Python methods „Åå registry „Å´ÁôªÈå≤„Åï„Çå„Çã
- [ ] „Çπ„Çø„ÉñÈñ¢Êï∞„ÅåÈÅ©Âàá„Å™„Ç®„É©„Éº„ÇíËøî„Åô

---

## „Ç≥„Éü„ÉÉ„ÉàÊâãÈ†Ü

```bash
git add packages/cfomicsPython/
git commit -m "feat: add cfomicsPython package skeleton

- Create package structure for Python backends
- Add Python environment management stubs
- Register Python methods with cfomics registry
- Add cf_check_env() for environment diagnostics

Note: This is a skeleton. Full implementation in PR-4.

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

## PR ‰ΩúÊàê

```bash
git push -u origin feature/cfomics-python-skeleton

gh pr create --title "feat: add cfomicsPython package skeleton" --body "$(cat <<'EOF'
## Summary

Create the skeleton for `cfomicsPython` package, which will contain Python-based causal inference methods.

## Changes

- `packages/cfomicsPython/` - New package directory
- Python environment management stubs
- Method registration with cfomics registry
- Basic tests for package structure

## APIs (Stubs)

- `cf_install_python_env()` - Install Python environment
- `cf_use_python_env()` - Activate Python environment
- `cf_check_env()` - Check environment status
- `cf_list_python_envs()` - List available environments

## Registered Methods

- `dowhy_gcm` - DoWhy GCM
- `drlearner` - EconML DRLearner
- `ganite` - GANITE
- `cavae` - CAVAE

All method implementations are stubs pending PR-4.

## Test plan

- [ ] `R CMD check` passes
- [ ] Methods appear in `cf_methods(include_unavailable = TRUE)`
- [ ] Stub functions return appropriate errors

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

---

*Last updated: 2026-01-05*
