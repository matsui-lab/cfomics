# シミュレーション設計

本章では、因果推論手法を評価するために使用されるシミュレーションフレームワークについて説明する。次元、処置効果の異質性、および仮定の違反の様々な条件下で手法性能を体系的にテストするために、11のデータ生成過程（DGP）を設計した。

## 一般的なフレームワーク

### データ生成過程

各DGPは以下の一般的な構造に従う：

1. **共変量の生成**：$X \sim \mathcal{N}(0, \Sigma)$ ここで $\Sigma$ はシナリオに依存
2. **傾向スコア**：$\pi(X) = P(T=1 \mid X) = \text{expit}(g(X))$
3. **処置の割り当て**：$T \sim \text{Bernoulli}(\pi(X))$
4. **潜在アウトカム**：
   - $Y(0) = f_0(X) + \epsilon$
   - $Y(1) = f_1(X) + \epsilon = f_0(X) + \tau(X) + \epsilon$
5. **観測アウトカム**：$Y = T \cdot Y(1) + (1-T) \cdot Y(0)$

ここで $\epsilon \sim \mathcal{N}(0, \sigma^2)$ であり、$\sigma^2$ は目標のシグナル対ノイズ比に対して調整される。

### 真の処置効果

真の平均処置効果は以下のように計算される：
$$\tau_{true} = \frac{1}{n}\sum_{i=1}^n \tau(X_i)$$

均質効果を持つシナリオでは、$\tau(X) = \tau_0$（定数）となる。

### 評価指標

4つの主要指標を使用して手法を評価する：

```{r metrics-table, echo=FALSE}
metrics_table <- data.frame(
  Metric = c("バイアス", "RMSE", "PEHE", "被覆率"),
  Formula = c(
    "$\\hat{\\tau} - \\tau_{true}$",
    "$\\sqrt{(\\hat{\\tau} - \\tau_{true})^2}$",
    "$\\sqrt{\\frac{1}{n}\\sum_i(\\hat{\\tau}_i - \\tau_i)^2}$",
    "$\\mathbb{1}[\\tau_{true} \\in CI_{95}]$"
  ),
  Description = c(
    "系統的推定誤差（0に近いべき）",
    "バイアスと分散を組み合わせた二乗平均平方根誤差",
    "異質効果の推定精度",
    "真のATEを含む95%信頼区間の割合"
  )
)

if (requireNamespace("kableExtra", quietly = TRUE)) {
  kableExtra::kbl(metrics_table, booktabs = TRUE, escape = FALSE,
                  caption = "主要評価指標",
                  col.names = c("指標", "計算式", "説明")) |>
    kableExtra::kable_styling(latex_options = c("hold_position"))
} else {
  knitr::kable(metrics_table, caption = "主要評価指標")
}
```

## シナリオの説明

### S1: ベースライン (dgp_baseline)

ベースラインシナリオは、理想的な条件下での参照性能を確立する：

- **共変量**：$X \sim \mathcal{N}(0, I_p)$、独立標準正規
- **傾向スコア**：$\pi(X) = \text{expit}(0.5 X_1 + 0.5 X_2 + 0.5 X_3)$
- **アウトカム**：$Y(0) = X_1 + X_2 + X_3 + \epsilon$
- **処置効果**：$\tau = 1$（均質）
- **設定**：$n \in \{500, 1000, 2000\}$、$p \in \{50, 100\}$

このシナリオは線形かつ正しく指定されたモデルで、すべての標準的な因果仮定を満たす。

### S2: 次元スイープ (dgp_dimension_sweep)

次元が増加するにつれての手法のスケーラビリティをテストする：

- **共変量**：ベースラインと同様
- **設定**：$n \in \{500, 1000\}$、$p \in \{100, 500, 1000\}$
- **課題**：$p/n$ 比が0.2から2.0まで

手法は正則化または変数選択を活用して、$p$ が増加しても性能を維持すべきである。

### S3: 異質効果 - 線形 (dgp_heterogeneous_linear)

処置効果の異質性を捉える能力をテストする：

- **処置効果**：$\tau(X) = \tau_0 + \gamma \cdot X_1$
- **強度パラメータ**：$\gamma \in \{0, 0.5, 1.0, 2.0\}$
- **課題**：ITE推定精度

異質効果向けに設計されたBCFのような手法がここで優れるべきである。

### S4: 異質効果 - 複雑

異なる異質性パターンをテストする3つのサブシナリオ：

**S4a: 非線形異質性 (dgp_heterogeneous_nonlinear)**
$$\tau(X) = 1 + \sin(\pi X_1) + X_2^2$$

**S4b: サブグループ異質性 (dgp_heterogeneous_subgroup)**
$$\tau(X) = \begin{cases} 2 & \text{if } X_1 > 0 \\ 0.5 & \text{if } X_1 \leq 0 \end{cases}$$

**S4c: 質的交互作用 (dgp_heterogeneous_qualitative)**
$$\tau(X) = \text{sign}(X_1) \cdot |X_1|$$

処置効果は共変量に応じて正または負になりうる。

### S5: 非線形交絡 (dgp_nonlinear_confounding)

モデル誤指定に対する頑健性をテストする：

- **設定**：5つの非線形タイプ

| タイプ | 傾向関数 | アウトカム関数 |
|------|--------------------|--------------------|
| 二次 | $g(X) = X_1^2 + X_2^2$ | $f(X) = X_1^2 + X_2^2$ |
| 三角関数 | $g(X) = \sin(\pi X_1)$ | $f(X) = \cos(\pi X_2)$ |
| 交互作用 | $g(X) = X_1 \cdot X_2$ | $f(X) = X_1 \cdot X_2 \cdot X_3$ |
| 混合 | 上記の混合 | 上記の混合 |
| 閾値 | $g(X) = \mathbb{1}[X_1 > 0]$ | ステップ関数 |

線形手法は苦戦すべきであり、木ベースの手法は適応すべきである。

### S6: 高密度交絡 (dgp_dense_confounding)

多くの共変量が真の交絡因子である場合の性能をテストする：

- **共変量**：$p = 500$
- **真の交絡因子**：$k \in \{10, 50, 100, 200\}$
- **課題**：高密度交絡下での変数選択

良好な変数選択を持つ手法（HDPS、HDML）が良好に機能すべきである。

### S7: 弱いオーバーラップ (dgp_weak_overlap)

陽性仮定の違反に対する頑健性をテストする：

- **オーバーラップ強度**：良好、中程度、弱い、極端
- **傾向スコア範囲**：
  - 良好：$[0.2, 0.8]$
  - 中程度：$[0.1, 0.9]$
  - 弱い：$[0.05, 0.95]$
  - 極端：$[0.01, 0.99]$

IPWベースの手法は劣化すべきであり、アウトカム回帰はより安定する可能性がある。

### S8: 共変量シフト (dgp_covariate_shift)

処置が共変量分布に影響を与える場合の性能をテストする：

**S8a: 平均シフト**
$$X \mid T=1 \sim \mathcal{N}(\mu_1, I), \quad X \mid T=0 \sim \mathcal{N}(\mu_0, I)$$

**S8b: 分散シフト**
$$X \mid T=1 \sim \mathcal{N}(0, \sigma_1^2 I), \quad X \mid T=0 \sim \mathcal{N}(0, \sigma_0^2 I)$$

### S9: 相関のある交絡 (dgp_correlated_confounding)

非独立な共変量での性能をテストする：

- **相関構造**：
  - **ブロック**：相関のあるブロック内の共変量
  - **AR(1)**：自己回帰的な相関減衰
  - **因子**：潜在因子構造

実際のオミクスデータは通常、強い相関パターンを示す。

### S10: 観測されない交絡 (dgp_unobserved_confounding)

測定されない交絡因子に対する感度をテストする：

- **観測されない交絡因子**：$U \sim \mathcal{N}(0, 1)$
- **影響**：処置とアウトカムの両方
- **強度パラメータ**：$\gamma_U \in \{0, 0.5, 1.0, 2.0\}$

$\gamma_U$ が増加するにつれて、すべての手法はバイアスの増加を示すべきである。これは観測手法の基本的な限界をテストする。

### S11: 合流点バイアス (dgp_collider)

合流点条件付けに対する脆弱性をテストする：

- **合流点変数**：$C = f(T, Y) + \epsilon$
- **共変量に（誤って）含まれる**
- **強度パラメータ**：$\gamma_C \in \{0, 0.5, 1.0, 2.0\}$

すべての共変量を素朴に含める手法はバイアスを示す；変数選択手法は合流点を避ける可能性がある。

## シナリオの要約

```{r scenario-summary, echo=FALSE}
scenario_summary <- data.frame(
  Scenario = c("S1", "S2", "S3", "S4a-c", "S5", "S6", "S7", "S8", "S9", "S10", "S11"),
  Description = c(
    "ベースライン（線形、正しい指定）",
    "次元スイープ（pは最大1000）",
    "線形異質性",
    "複雑な異質性パターン",
    "非線形交絡",
    "高密度交絡",
    "弱いオーバーラップ",
    "共変量シフト",
    "相関のある交絡因子",
    "観測されない交絡",
    "合流点バイアス"
  ),
  `Primary Challenge` = c(
    "なし（参照）",
    "高次元",
    "ITE推定",
    "非線形効果",
    "モデル誤指定",
    "変数選択",
    "陽性仮定の違反",
    "分布シフト",
    "相関の処理",
    "識別可能性",
    "変数選択"
  ),
  `n Configs` = c(6, 6, 4, 3, 5, 4, 4, 2, 3, 4, 4),
  check.names = FALSE
)

if (requireNamespace("kableExtra", quietly = TRUE)) {
  kableExtra::kbl(scenario_summary, booktabs = TRUE,
                  caption = "シミュレーションシナリオの要約",
                  col.names = c("シナリオ", "説明", "主要課題", "設定数")) |>
    kableExtra::kable_styling(latex_options = c("hold_position", "scale_down"))
} else {
  knitr::kable(scenario_summary, caption = "シミュレーションシナリオの要約")
}
```

## 反復設計

- **シナリオあたりの反復回数**：50の独立したデータセット
- **乱数シード**：`base_seed + job_index` により再現可能
- **総シミュレーション実行回数**：`r nrow(expand.grid(scenario = 1:45, rep = 1:50))` （45設定 x 50反復）

公正な比較を保証するため、各手法は同一のデータセットで評価される。
