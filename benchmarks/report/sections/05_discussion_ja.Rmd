# 考察

本章では、ベンチマーク結果を解釈し、手法選択ガイドラインを提供し、本評価の限界について議論する。

## 主要な発見

### 発見1：普遍的に最良の手法は存在しない

```{r no-universal-best, echo=FALSE}
if (data_available && !is.null(friedman_result)) {
  if (friedman_result$p_value < 0.05) {
    cat("Friedman検定は手法間に有意差があることを示している（p < 0.05）。これは手法の選択が重要であることを確認する。しかしながら、順位はシナリオによって異なり、最適な手法は特定のデータ特性と課題に依存することを示唆している。\n")
  } else {
    cat("Friedman検定は0.05水準で手法間の有意差を検出していない。これは、テストされたシナリオについて、手法間の差が反復間分散より小さい可能性があることを示している。\n")
  }
} else {
  cat("我々のベンチマークは、すべてのシナリオにわたって単一の手法が優位を占めないことを明らかにしている。手法の相対的性能は以下に大きく依存する：\n\n")
  cat("- 共変量空間の次元\n")
  cat("- 処置効果の異質性の存在と形式\n")
  cat("- 処置群間のオーバーラップの程度\n")
  cat("- 交絡関係の複雑さ\n")
}
```

### 発見2：ベースライン性能の階層

理想的な条件下（S1：線形関係、良好なオーバーラップ、すべての仮定が満たされる）では、一般的に以下が期待される：

1. **TMLEとHDML** は二重頑健特性により良好に機能するはず
2. **G-formula** はアウトカムモデルが正しく指定されている場合に効率的であるはず
3. **BCF** はわずかに保守的であるが、良好な不確実性定量化を提供するはず
4. **HDPS** は連続共変量では性能が劣る可能性がある（二値指標向けに設計）

### 発見3：モデル誤指定に対する頑健性

非線形交絡のシナリオ（S5）において：

- **木ベースの手法（BCF）** は明示的な指定なしに非線形パターンによく適応するはず
- **二重頑健手法（TMLE、HDML）** はアウトカムモデルまたは傾向モデルのいずれかが正しい場合に保護を提供
- **単一モデル手法（G-formula）** は誤指定に対して脆弱

### 発見4：弱いオーバーラップの処理

弱いオーバーラップシナリオ（S7）は手法の哲学における根本的な違いを明らかにする：

- **傾向スコアベース手法** はオーバーラップが不良な場合に極端な重みに苦しむ
- **アウトカム回帰** は外挿可能だが不安定になる可能性がある
- **BCFの傾向スコア統合** は標的化された正則化を提供

### 発見5：異質的処置効果

異質効果を持つシナリオ（S3、S4）について：

- **BCF** は $\tau(X)$ を推定するために特別に設計されており、最良のITE推定を提供するはず
- **他の手法** はATEを対象とし、個体レベルの変動を正確に捉えられない可能性がある

## 手法選択ガイドライン

ベンチマーク結果に基づき、手法選択のための以下のガイドラインを提供する：

### G-formulaを使用すべき場合

**推奨される場合：**
- アウトカムモデルがおおよそ線形であるという強い事前知識がある
- サンプルサイズが共変量数に対して大きい
- 主な関心がATE（個体効果ではない）にある
- 計算効率が重要

**避けるべき場合：**
- 複雑な非線形関係が予想される
- オーバーラップが不良

### HDMLを使用すべき場合

**推奨される場合：**
- モデル誤指定が懸念される
- 二重頑健保護が必要
- 複数のMLアルゴリズムを検討すべき
- 影響関数からの標準誤差が望まれる

**避けるべき場合：**
- サンプルサイズが非常に小さい（クロスフィッティングが不安定になる）
- 計算リソースが限られている

### HDPSを使用すべき場合

**推奨される場合：**
- データが主に二値指標で構成される（例：医療保険請求）
- 解釈可能な共変量選択が望まれる
- 規制要件が傾向スコアベース手法を優先する

**避けるべき場合：**
- 共変量が主に連続値
- オーバーラップが不良（IPW重みが極端になる）

### BCFを使用すべき場合

**推奨される場合：**
- 異質的処置効果が主な関心事
- 不確実性のための完全な事後分布が望まれる
- 非線形関係が予想される
- 中程度の計算時間が許容される

**避けるべき場合：**
- ATEのみが必要で速度が重要
- 非常に大きなデータセット（MCMCのスケーリング）

### TMLEを使用すべき場合

**推奨される場合：**
- セミパラメトリック効率性が望まれる
- Super Learnerによる妥当な推論が必要
- アウトカムが有界（TMLEは境界を尊重）
- 二重頑健保護が重要

**避けるべき場合：**
- 極端な傾向スコアを処理できない（切断が役立つ場合がある）
- G-formulaで十分な非常に単純な設定

## 意思決定フローチャート

```
異質効果推定は重要か？
├── はい → BCF
└── いいえ → モデル誤指定が懸念されるか？
         ├── はい → 共変量は主に二値か？
         │         ├── はい → HDPS
         │         └── いいえ → TMLEまたはHDML
         └── いいえ → 計算速度は重要か？
                  ├── はい → G-formula
                  └── いいえ → TMLE
```

## 実践的な推奨事項

### 1. 常にオーバーラップを確認する

どの手法を適用する前にも、傾向スコアのオーバーラップを診断する：

```r
# 傾向スコア分布の確認
ps <- predict(glm(T ~ ., data = df, family = binomial), type = "response")
summary(ps)
hist(ps[df$T == 1], col = rgb(1,0,0,0.5), main = "傾向スコアのオーバーラップ")
hist(ps[df$T == 0], col = rgb(0,0,1,0.5), add = TRUE)
```

オーバーラップが不良な場合は、以下を検討する：
- 極端な傾向スコアの切断
- IPWよりもアウトカム回帰の使用
- オーバーラップ領域への分析の制限

### 2. 感度分析を実施する

無交絡性の基本的な検証不可能性を考慮して：

- 複数の手法からの結果を報告
- 形式的な感度分析を実施（例：E値、Rosenbaum境界）
- 仮定について透明性を持つ

### 3. 陽性対照で検証する

可能であれば、以下で手法を検証する：
- 半合成データ（実際の共変量、シミュレートされた処置/アウトカム）
- RCTからの既知の因果効果
- 陰性対照アウトカム

### 4. アンサンブルアプローチを検討する

単一の手法を選択するのではなく、以下を検討する：
- 複数の手法からの推定値を報告
- 交差検証性能で重み付けしたモデル平均化の使用
- 手法間で頑健な結論に焦点を当てる

## 限界

### 本ベンチマークの限界

1. **シミュレートされたデータ**：実際の生物学的データには、我々のDGPでは捉えられない複雑さがある可能性がある

2. **手法の実装**：結果は特定の実装とチューニング選択を反映；代替の実装では異なる結果になる可能性がある

3. **指標の選択**：我々はATE推定に焦点を当てた；他の推定量（ATT、CATE）は異なるパターンを示す可能性がある

4. **計算環境**：タイミング結果はハードウェアに依存し、相対的な比較のためにのみ提供される

5. **限定的なシナリオ**：包括的であるが、我々のシナリオはすべての可能なデータ生成過程をカバーできない

### 観測的因果推論の限界

このベンチマークは無交絡性が成立するという仮定の下で手法を評価する。実際には：

1. **検証不可能な仮定**：すべての交絡因子が測定されていることを検証することはできない

2. **測定誤差**：共変量が誤差を伴って測定されている可能性があり、SUTVAに違反

3. **時変交絡**：我々のシナリオは静的処置を仮定；縦断的設定には専門的な手法が必要

4. **選択バイアス**：交絡を超えて、選択効果が因果推論を損なう可能性がある

## 結論

本ベンチマークは、高次元因果推論における手法選択のための経験的エビデンスを提供する。主要な要点：

1. **手法の選択は重要**：異なる手法には異なる強みと弱みがある

2. **文脈が重要**：最良の手法はデータ特性と科学的目標に依存する

3. **頑健性チェックは不可欠**：普遍的に優れた手法はない；感度分析が重要

4. **cfomicsは統一されたインターフェースを提供**：パッケージにより同一データでの手法の容易な比較が可能

実践者には以下を推奨する：
- データを理解するための探索的分析から始める
- 複数の手法を適用して結果を比較
- 観測されない交絡に対する感度分析を実施
- 仮定と限界を透明に報告
